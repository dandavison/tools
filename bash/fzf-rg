#!/bin/bash

RG="rg $@ --color=always"
BAT="bat --color=always --style=header,grid"
DELTA="delta --grep-output-type classic"

fzf() {
    command fzf \
        --layout reverse \
        --info hidden \
        --prompt ' ' \
        --color light \
        --ansi \
        --bind 'ctrl-k:kill-line' \
        "$@"
}

declare preview="$BAT -H {2} -r {2}:+80 {1}"

$RG --json . 2>/dev/null |
    $DELTA |
    fzf -d: \
        --query="${*}" \
        --phony \
        --bind="change:reload:$RG --json {q} | $DELTA" \
        --bind='enter:execute:code -g {1}:{2}' \
        --preview="[[ -n {1} ]] && $preview"
