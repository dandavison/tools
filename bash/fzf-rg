#!/bin/bash

declare preview='echo; bat --color=always --style=header -H {2} {1} | rg -C3 {q}'

while getopts ':l' x; do
    case "$x" in
    l)
        list_files=1
        preview='echo; bat --color=always --style=header {1} | rg -C3 {q}'
        ;;
    esac
done
shift $((OPTIND - 1))
unset x OPTARG OPTIND

fzf() {
    command fzf \
        --layout reverse \
        --info hidden \
        --preview-window='~1' \
        --prompt ' ' \
        --color light \
        --ansi \
        "$@"
}

rg --color=always -n ${list_files:+-l} --json "$1" 2>/dev/null | delta --grep-output-type classic |
    fzf -d: \
        --query="$1" \
        --phony \
        --bind="change:reload:rg -n ${list_files:+-l} --color=always --json {q} | delta --grep-output-type classic" \
        --bind='enter:execute:code -g {1}:{2}' \
        --preview="[[ -n {1} ]] && $preview"
