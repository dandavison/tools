#!/usr/bin/env -S uv run --script
#
# /// script
# requires-python = ">=3.9"
# dependencies = ["markdown-it-py"]
# ///
"""Run the first Python code block from a markdown file or GitHub issue/comment URL."""

from __future__ import annotations

import re
import subprocess
import sys
from markdown_it import MarkdownIt


def find_first_code_block(markdown_text: str, language: str = "python") -> str | None:
    """Extract the first fenced code block with the given language from markdown."""
    md = MarkdownIt()
    tokens = md.parse(markdown_text)

    for token in tokens:
        if token.type == "fence" and token.tag == "code":
            # token.info contains the language hint (e.g., "python")
            if token.info.strip().lower() == language.lower():
                return token.content
    return None


def gh_api(endpoint: str, jq: str = ".") -> str:
    """Call gh api and return the result."""
    result = subprocess.run(
        ["gh", "api", endpoint, "--jq", jq],
        capture_output=True,
        text=True,
        check=True,
    )
    return result.stdout


def find_code_in_github_issue(owner: str, repo: str, issue_num: str) -> str | None:
    """Find first Python code block in issue body or comments."""
    # First check issue body
    body = gh_api(f"repos/{owner}/{repo}/issues/{issue_num}", ".body")
    code = find_first_code_block(body)
    if code:
        return code

    # Then check comments
    comments = gh_api(
        f"repos/{owner}/{repo}/issues/{issue_num}/comments", ".[].body"
    )
    return find_first_code_block(comments)


def fetch_github_content(url: str) -> str | None:
    """Fetch markdown content from a GitHub issue or comment URL using gh CLI.

    Returns the code to execute, or None if not found.
    """
    # Match issue comment URL: https://github.com/owner/repo/issues/123#issuecomment-456
    comment_match = re.match(
        r"https://github\.com/([^/]+)/([^/]+)/issues/\d+#issuecomment-(\d+)", url
    )
    if comment_match:
        owner, repo, comment_id = comment_match.groups()
        body = gh_api(f"repos/{owner}/{repo}/issues/comments/{comment_id}", ".body")
        return find_first_code_block(body)

    # Match issue URL: https://github.com/owner/repo/issues/123
    issue_match = re.match(
        r"https://github\.com/([^/]+)/([^/]+)/issues/(\d+)$", url
    )
    if issue_match:
        owner, repo, issue_num = issue_match.groups()
        return find_code_in_github_issue(owner, repo, issue_num)

    raise ValueError(f"Unrecognized GitHub URL format: {url}")


def get_code(source: str) -> str | None:
    """Get Python code from a file path or GitHub URL."""
    if source.startswith("https://github.com/"):
        return fetch_github_content(source)

    with open(source) as f:
        return find_first_code_block(f.read())


def has_uv_script_metadata(code: str) -> bool:
    """Check if code contains uv script metadata (PEP 723 inline script metadata)."""
    return "# /// script" in code


def run_code(code: str) -> None:
    """Run the code, using uv if it has script metadata."""
    if has_uv_script_metadata(code):
        # Write to temp file and run via uv
        import tempfile

        with tempfile.NamedTemporaryFile(mode="w", suffix=".py", delete=False) as f:
            f.write(code)
            temp_path = f.name
        try:
            result = subprocess.run(["uv", "run", "--script", temp_path])
            sys.exit(result.returncode)
        finally:
            import os
            os.unlink(temp_path)
    else:
        exec(code, {"__name__": "__main__"})


def main():
    if len(sys.argv) != 2:
        print(f"Usage: {sys.argv[0]} <markdown-file-or-github-url>", file=sys.stderr)
        sys.exit(1)

    source = sys.argv[1]

    try:
        code = get_code(source)
    except FileNotFoundError:
        print(f"Error: File not found: {source}", file=sys.stderr)
        sys.exit(1)
    except subprocess.CalledProcessError as e:
        print(f"Error fetching from GitHub: {e.stderr}", file=sys.stderr)
        sys.exit(1)
    except ValueError as e:
        print(f"Error: {e}", file=sys.stderr)
        sys.exit(1)

    if code is None:
        print("No Python code block found", file=sys.stderr)
        sys.exit(1)

    run_code(code)


if __name__ == "__main__":
    main()

